Handlebars.registerHelper("compare",function(t,e,i,s){if(arguments.length<3)throw new Error("Handlerbars Helper 'compare' needs 2 parameters");try{switch(e.toString()){case"==":return t==i?s.fn(this):s.inverse(this);case"!=":return t!=i?s.fn(this):s.inverse(this);case"===":return t===i?s.fn(this):s.inverse(this);case"!==":return t!==i?s.fn(this):s.inverse(this);case"<":return i>t?s.fn(this):s.inverse(this);case"<=":return i>=t?s.fn(this):s.inverse(this);case">":return t>i?s.fn(this):s.inverse(this);case">=":return t>=i?s.fn(this):s.inverse(this);case"&&":return t&&i?s.fn(this):s.inverse(this);case"||":return t||i?s.fn(this):s.inverse(this);case"indexOf":return t.indexOf(i)>-1?s.fn(this):s.inverse(this);default:return s.inverse(this)}}catch(n){console.log("Errow: hbs.compare v1="+t+";v2="+i+n)}}),Handlebars.registerHelper("pagination",function(t,e,i,s){var n="",s=s,i=i;3===arguments.length&&(s=i,i=9);for(var o=Est.getPaginationNumber(t,e,i),a=0,l=o.length;l>a;a++)n+=s.fn(o[a]);return n}),Handlebars.registerHelper("get",function(t,e){if("undefined"==typeof t||"string"!==Est.typeOf(t))return t;var i=t.split(".");return i[0]in this?i.length>1?("object"!==Est.typeOf(this[i[0]])&&(this[i[0]]=JSON.parse(this[i[0]])),Est.getValue(this,t)):this[i[0]]:void 0}),Handlebars.registerHelper("dateFormat",function(t,e,i){return Est.dateFormat(t,e)}),Handlebars.registerHelper("contains",function(t,e,i){return Est.isEmpty(t)?void 0:Est.contains(t,e)?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("plus",function(t,e,i){return parseInt(t,10)+parseInt(e,10)}),Handlebars.registerHelper("minus",function(t,e,i){return parseInt(t,10)-parseInt(e,10)+""}),Handlebars.registerHelper("cutByte",function(t,e,i){return Est.cutByte(t,e,i.hash.end||"...")}),Handlebars.registerHelper("x",function(t,e){var i,s=function(){};try{s=Function.apply(this,["window","return "+t+";"])}catch(n){console.warn("[warning] {{x "+t+"}} is invalid javascript",n)}try{i=s.bind(this)(window)}catch(n){console.warn("[warning] {{x "+t+"}} runtime error",n)}return i}),Handlebars.registerHelper("xif",function(t,e){return Handlebars.helpers.x.apply(this,[t,e])?e.fn(this):e.inverse(this)}),Handlebars.registerHelper("parseInt",function(t,e){return parseInt(t,10)}),Handlebars.registerHelper("id2",function(t){return null==t?"":t.replace(/^[^1-9]+/,"")}),Handlebars.registerHelper("CONST",function(t,e){return Est.getValue(CONST,t)}),Handlebars.registerHelper("picUrl",function(t,e,i){var s=t;if(arguments.length<3)return t||CONST.PIC_NONE;if(null==t||0==t.length)return CONST.PIC_NONE;if(e>10)s=s+"!"+e;else{var n=s.substring(s.lastIndexOf(".")+1,s.length);s=s.substring(0,s.lastIndexOf("."))+"_"+e+"."+n}return s?s:""}),Handlebars.registerHelper("_picUrl",function(t,e,i){return CONST.PIC_URL+"/"+Handlebars.helpers.picUrl.apply(this,[t,e,i])}),Handlebars.registerHelper("PIC",function(t,e,i){var s="";return t&&(s+=t.indexOf("?")>-1?"&v="+Est.hash(CONST.APP_VERSION):"?v="+Est.hash(CONST.APP_VERSION),Est.startsWidth(t,"CONST")&&(t=Handlebars.helpers.CONST.apply(this,[t.replace("CONST.",""),i]))),t&&/[^\s]+\.(?:jpe?g|gif|png|bmp)/i.test(t)?(Est.startsWidth(t,"http")&&t.indexOf("upload")>-1&&(t=t.substring(t.indexOf("upload"),t.length)),Est.startsWidth(t,"upload")?arguments.length<3?CONST.PIC_URL+"/"+t+s:Handlebars.helpers._picUrl.apply(this,[t,e,i])+s:Est.startsWidth(t,"http")?t+s:CONST.DOMAIN+t+s):CONST.DOMAIN+CONST.PIC_NONE+s}),Handlebars.registerHelper("isEmpty",function(t,e){return Est.isEmpty(t)?e.fn(this):e.inverse(this)}),Handlebars.registerHelper("encodeUrl",function(t,e){return encodeURIComponent(t)}),Handlebars.registerHelper("json",function(t,e){return Handlebars.helpers.get.call(this,t)}),Handlebars.registerHelper("version",function(t,e){switch(t){case"time":return(new Date).getTime();case"hash":return Est.hash((new Date).getTime());default:return Est.hash((new Date).getTime())}}),Handlebars.registerHelper("stripScripts",function(t,e){return Est.stripScripts(t)}),Handlebars.registerHelper("replace",function(t,e,i,s){return t.replace(new RegExp(e,"img"),i)}),Handlebars.registerHelper("default",function(t,e,i){return Est.isEmpty(t)?e:t}),Handlebars.registerHelper("keyMap",function(t,e,i){return t&&e?e[t]:""});var BaseApp=function(t){this.options=t,Est.extend(this,t),this.initialize.apply(this,arguments)};Est.extend(BaseApp.prototype,{initialize:function(){this.data={itemActiveList:[],sessionId:""},this.instance={},this.modules={},this.routes={},this.templates={},this.panels={},this.dialog=[],this.dialogs={},this.status={},this.cookies=[],this.models=[],this.compileTemps={},this.filters={navigator:[],form:[]},this.cache={}},getAppType:function(){return"backbone"},addRegion:function(t,e,i){var s=Est.nextUid("region");return i.__panelId||(i.__panelId=i.el),i.diff&&app.getView(i.viewId||t)?(app.getView(i.viewId||t)._extend(i),void app.getView(i.viewId||t)._reset(i.data)):(this.addPanel(t,{el:i.__panelId,template:'<div class="region '+s+'"></div>'},i),i.viewId||(i.viewId=t),i.viewId in this.instance&&this.removeView(i.viewId),this.addView(i.viewId,new e(i)))},addPanel:function(t,e,i){var s="string"===Est.typeOf(e.cid)?!1:!0;return i=i||{},s&&(this.removePanel(t,e),e.$template=$(e.template),i&&(i.el=e.$template),e.$template.addClass("__panel_"+t),e.$template.attr("data-view",i.viewId||t),i&&"boolean"===Est.typeOf(i.append)&&!i.append&&$(e.el).empty(),$(e.el).append(e.$template)),this.panels[t]=e,s?this:e},removePanel:function(t,e){try{var i=[];e||(e=this.panels[t]),"body"!==e.el&&($(".region",$(e.el)).each(function(){i.push($(this).attr("data-view"))}),i.reverse(),Est.each(i,function(t){app.getView(t)&&app.getView(t).destroy&&app.getView(t).destroy(),app.removeView(t)})),$(".__panel_"+t,$(e.el)).off().remove(),delete this.panels[t]}catch(s){console.error(s)}},addView:function(t,e){return t in this.instance&&this.removeView(t),this.instance[t]=e,this.setCurrentView(t),this.instance[t]},removeView:function(t){try{this.getView(t)&&(this.getView(t).destroy&&this.getView(t).destroy(),this.getView(t)._empty(),this.getView(t).stopListening(),this.getView(t).$el.off().remove()),delete this.instance[t]}catch(e){console.log(e)}return this},panel:function(t,e){return this.addPanel(t,e)},show:function(t){this.addView(this.currentView,t)},getPanel:function(t){return this.panels[t]},add:function(t,e){return this.addView(t,e)},setCurrentView:function(t){this.currentView=t},getCurrentView:function(){return this.currentView},getView:function(t){return this.instance[t]},addDialog:function(t,e){return this.dialog.push(t),e&&(app.addData("_curDialog",e),this.dialogs[e]=t),t},getDialogs:function(){return this.dialog},getDialog:function(t){return Est.isEmpty(t)?this.dialogs:this.dialogs[t]},getCurrentDialog:function(){return app.getData("_curDialog")?this.dialogs[app.getData("_curDialog")]:null},emptyDialog:function(){Est.each(this.dialog,function(t){t&&t.close&&t.close().remove()}),this.dialog=[],this.dialogs={},app.addData("_curDialog",null)},addModel:function(t){return this.models.push(t),t},getModels:function(){return this.models},addData:function(t,e){t in this.data&&debug("reset data "+t),this.data[t]=e},getData:function(t){return this.data[t]},addModule:function(t,e){t in this.modules&&debug("Error10 module="+t),this.modules[t]=e},getModules:function(){return this.modules},addRoute:function(t,e){t in this.routes&&debug("Error13 "+t),this.routes[t]=e},getRoutes:function(){return this.routes},addTemplate:function(t,e){t in this.templates&&debug("Error11 template name:"+t),this.templates[t]=e},getTemplates:function(){return this.templates},addSession:function(t,e,i){try{var s="undefined"===Est.typeOf(i)?"":i?this.data.sessionId:"";localStorage["___JHW_BACKBONE__"+Est.hash(s+t)]=e}catch(n){debug("Error9 "+n)}return e},getSession:function(t,e){var i="undefined"===Est.typeOf(e)?"":e?this.data.sessionId:"";return localStorage["___JHW_BACKBONE__"+Est.hash(i+t)]},addCompileTemp:function(t,e){this.compileTemps[t]=e},getCompileTemp:function(t){return this.compileTemps[t]},addStatus:function(t,e){this.status[t]=e},getStatus:function(t){return this.status[t]},getAllStatus:function(){return this.status},addOption:function(t,e){this.options[t]=e},getOption:function(t){return Est.cloneDeep(this.options[t])},addFilter:function(t,e){this.filters[t].push(e)},getFilters:function(t){return this.filters[t]},getParamsHash:function(t){var e="",i="";for(var s in t)e+=t[s];return i="_hash"+Est.hash(e)},addCache:function(t,e){try{var i="";if(!e.success)return;i=this.getParamsHash(t),t.session&&e?app.addSession(i,JSON.stringify(e)):this.cache[i]=e}catch(s){debug("Error12"+s)}},getCache:function(t){var e=null,i=this.getParamsHash(t);return!t.session||app.getData("versionUpdated")?this.cache[i]:(e=app.getSession(i))?JSON.parse(e):void 0},removeCache:function(t){var e=null;return t?(e=this.getParamsHash(t),void delete this.cache[e]):void(this.cache={})},addCookie:function(t){-1===Est.findIndex(this.cookies,t)&&this.cookies.push(t)},getCookies:function(){return this.cookies}});var BaseUtils={dialog:function(t){var e=t.button||[];seajs.use(["dialog-plus"],function(i){t.success&&e.push({value:CONST.LANG.CONFIRM,autofocus:!0,callback:function(){t.success.apply(this,arguments)}}),t.hideCloseBtn||e.push({value:CONST.LANG.CLOSE,callback:function(){this.close().remove()}}),t=Est.extend({id:t.id||t.moduleId||Est.nextUid("dialog"),title:CONST.LANG.DIALOG_TIP,width:150,content:"",button:e},t),t.target&&(t.target=$(t.target).get(0)),t.oniframeload=function(){try{this.iframeNode.contentWindow.topDialog=thisDialog,this.iframeNode.contentWindow.app=app,delete app.getRoutes().index}catch(e){}"function"==typeof t.load&&t.load.call(this,arguments)},t.cover?app.addDialog(i(t),t.viewId||t.id).showModal(t.target):app.addDialog(i(t),t.viewId||t.id).show(t.target)})},tip:function(t,e){e=Est.extend({id:"tip-dialog"+Est.nextUid(),time:3e3,content:'<div style="padding: 10px;">'+t+"</div>",title:null},e),seajs.use(["dialog-plus"],function(t){window.tipsDialog&&window.tipsDialog.close().remove(),window.tipsDialog=app.addDialog(t(e)).show(e.target),setTimeout(function(){window.tipsDialog.close().remove()},e.time)})},confirm:function(t,e){var i={title:CONST.LANG.WARM_TIP,content:CONST.LANG.DEL_CONFIRM,success:function(){},target:null};Est.extend(i,t),e||(e=this),seajs.use(["dialog-plus"],function(s){window.comfirmDialog=app.addDialog(s({id:"dialog"+Est.nextUid(),title:i.title,content:'<div style="padding: 20px;">'+i.content+"</div>",width:i.width||200,button:[{value:t.successValue||CONST.LANG.CONFIRM,autofocus:!0,callback:function(){i.success&&i.success.call(e)}},{value:t.cancelValue||CONST.LANG.CANCEL,callback:function(){window.comfirmDialog.close().remove(),i.cancel&&i.cancel.call(e)}}],onClose:function(){i.cancel&&i.cancel.call(e)}})).show(i.target)})},addLoading:function(t){try{window.$loading&&window.$loading.remove(),window.$loading=$('<div id="loading" class="loading"><div class="object" id="object_one"></div><div class="object" id="object_two"></div><div class="object" id="object_three"></div></div>'),$("body").append(window.$loading)}catch(e){debug("Error28"+e)}return window.$loading},removeLoading:function(t){window.$loading?window.$loading.remove():$(".loading").remove()},execute:function(t){return debug("- BaseUtils.execute "+t),BaseUtils[t]&&BaseUtils[t].apply(BaseUtils,[].slice.call(arguments,1))}},BaseService=function(){return"object"==typeof BaseService.instance?BaseService.instance:(debug("build BaseService instance"),void(BaseService.instance=this))};BaseService.prototype={ajax:function(t){var e=Est.extend({_method:"GET"},t);return $.ajax({type:"post",url:t.url,async:!1,cache:t.cache,data:e,success:function(t){}})},initTree:function(t,e){t.tree&&(e.attributes.data=Est.bulidTreeNode(e.attributes.data,t.rootKey,t.rootValue,{categoryId:t.categoryId,belongId:t.belongId,childTag:t.childTag,sortBy:t.sortBy,callback:function(e){t.tree&&(e.text=e[t.text],e.value=e[t.value])}}))},initSelect:function(t,e){t.select&&(Est.each(e.attributes.data,function(e){e.text=e[t.text],e.value=e[t.value]}),t.tree&&(e.attributes.data=Est.bulidSelectNode(e.attributes.data,1,{name:"text"})))},initExtend:function(t,e){t.extend&&(e.attributes.data=Est.extendTree(e.attributes.data))},initDefault:function(t,e){e.attributes&&t.defaults&&"array"===Est.typeOf(e.attributes.data)&&e.attributes.data.unshift({text:CONST.LANG.SELECT_DEFAULT,value:t.defaultValue})},factory:function(t){var e=this,i=Est.promise,s="",n="",o=null;t=Est.extend({select:!1,extend:!1,defaults:!1,tree:!1,defaultValue:null,cache:!1},t);for(var a in t)s+=t[a];return n="_hash"+Est.hash(s),new i(t.session&&!app.getData("versionUpdated")&&(o=app.getSession(n))?function(t,e){t(JSON.parse(o))}:function(i,s){CONST.DEBUG_LOCALSERVICE?i([]):e.ajax(t).done(function(s){var o=null;return"string"===Est.typeOf(s)?(t.session&&s.attributes&&app.addSession(n,s),void i(s)):(s.attributes?(e.initTree(t,s),e.initSelect(t,s),e.initExtend(t,s)):(s.attributes=s.attributes||{},s.attributes.data=[]),e.initDefault(t,s),o=s.attributes?s.attributes.data:s,t.session&&s.attributes&&app.addSession(n,JSON.stringify(o)),void i(o))})})},query:function(t){var e=this,i=Est.promise,s="",n="",o=null;t=Est.extend({cache:!1},t);for(var a in t)s+=t[a];return n="_hash"+Est.hash(s),new i(t.session&&!app.getData("versionUpdated")&&(o=app.getSession(n))?function(t,e){t(JSON.parse(o))}:function(i,s){CONST.DEBUG_LOCALSERVICE?i([]):e.ajax(t).done(function(e){e.msg===CONST.LANG.NOT_LOGIN&&Est.trigger("checkLogin"),t.session&&e&&app.addSession(n,JSON.stringify(e)),i(e)})})}};var SuperView=Backbone.View.extend({constructor:function(t){this.options=t||{},this.init&&"function"!==Est.typeOf(this.init)&&this._initialize(this.init),Backbone.View.apply(this,arguments)},initialize:function(){this._initialize()},_super:function(){return this},_extend:function(t){Est.extend(this.options,t)},_navigate:function(t,e){e=e||!0,Backbone.history.navigate(t,e)},_dialog:function(t,e){var i=e||this,s=t.viewId?t.viewId:"string"===Est.typeOf(t.id)?t.id:t.moduleId;"function"===Est.typeOf(s)&&(s=Est.nextUid("dialog_view")),t=Est.extend({width:"auto",title:null,cover:!1,autofocus:!1,hideOkBtn:!0,hideCloseBtn:!0,button:[],quickClose:t.cover?!1:"boolean"===Est.typeOf(t.autofocus)?t.quickClose:!1,skin:"dialog_min"},t),t=Est.extend(t,{el:"#base_item_dialog"+s,content:t.content||'<div id="'+s+'"></div>',viewId:s,onshow:function(){try{var e=t.onShow&&t.onShow.call(this,t);if("undefined"!=typeof e&&!e)return;"function"===Est.typeOf(t.moduleId)?(t.id=t.id||t.viewId,app.addPanel(t.id,{el:"#"+t.id,template:'<div id="base_item_dialog'+t.id+'" class="region '+t.id+'"></div>'}).addView(t.id,new t.moduleId(t))):"string"===Est.typeOf(t.moduleId)&&seajs.use([t.moduleId],function(e){try{e||console.error(t.moduleId+" is not defined"),app.addPanel(t.viewId,{el:"#"+t.viewId,template:'<div id="base_item_dialog'+t.viewId+'" class="region"></div>'}).addView(t.viewId,new e(t))}catch(i){console.error(i)}})}catch(i){console.log(i)}},onclose:function(){app.getPanel(t.viewId)&&app.removePanel(t.viewId),t.onClose&&t.onClose.call(i,t),app.getDialogs().pop()}}),BaseUtils.dialog(t)},_singleBind:function(t,e,i,s){var n=this;$(e,t||this.$el).each(function(){var t=[],e=$(this).attr("bb-model"),i=$(this).attr("data-bind-type")||"change";Est.isEmpty(e)||(t=e.split(":"),i=t.length>1?t[1]:"change"),$(this).off(i).on(i,function(t){var e,i,o,a,l;if(37===t.keyCode||39===t.keyCode||38===t.keyCode||40===t.keyCode)return!1;if(o=$(this).attr("id"),l=$(this).attr("bb-model"),Est.isEmpty(l)||(l=l.split(":")[0]),l||o&&-1!==o.indexOf("model")){switch(this.type){case"radio":e=$(this).is(":checked")?$(this).val():i=!0;break;case"checkbox":e=$(this).is(":checked")?Est.isEmpty($(this).attr("true-value"))?!0:$(this).attr("true-value"):Est.isEmpty($(this).attr("false-value"))?!1:$(this).attr("false-value");break;default:e=$(this).val()}i||(a=l||o.replace(/^model\d?-(.+)$/g,"$1"),n._setValue(a,e),s&&s.call(n,a),n.update&&n.update.call(n,a))}})})},_modelBind:function(t,e,i){var s=this;e?this._singleBind(t,e,this.model,i):this.$("input, textarea, select").each(function(){s._singleBind(null,$(this),s.model,i)})},_viewReplace:function(t,e,i,s){try{Est.each(t.split(","),Est.proxy(function(t){var i=[],s="",n="",o=[],a="",l="";if(!Est.isEmpty(t))if(t.indexOf("]:")>-1?(o=t.split("]:"),i=Est.map(o,function(t,e){return e!==o.length-1?t+"]":t})):i=t.split(":"),n=Est.hash(t),i.length>1)for(var r=1;r<i.length;r++){if(n=Est.hash(i[0]+i[r]),l=i[r],Est.msie()?(a="ng-"+l,this["h_temp_"+n]||(s=this._options.template.replace(new RegExp("\\s"+i[r]+"=","img")," ng-"+i[r]+"="))):(a=l,s=this.$template),!this["h_temp_"+n])switch(l){case"html":this["h_temp_"+n]=Handlebars.compile($(s).find(i[0]).html());break;case"checked":this["h_temp_"+n]=Handlebars.compile("checked:{{#if "+/bb-checked=\"(.*?)\"\s?/gim.exec(i[0])[1]+"}}true{{else}}false{{/if}}");break;default:this["h_temp_"+n]=Handlebars.compile($(s).find(i[0]).attr(a))}if(_result=this["h_temp_"+n](e.attributes),this["h_temp_r_"+n]===_result)return void console.log("[ignore]"+i[0]+":"+l+" & result=>"+_result);switch(console.log("[replace]"+i[0]+":"+l+" & result=>"+_result),l){case"value":this.$(i[0]).val(_result);break;case"html":this.$(i[0]).html(_result);break;case"checked":this.$(i[0]).prop("checked",this._getValue(/bb-checked=\"(.*?)\"\s?/gim.exec(i[0])[1]));break;default:this.$(i[0]).attr(i[r],_result)}this["h_temp_r_"+n]=_result}else{if(Est.msie()?(l="ng-style",this["h_temp_"+n]||(s=this.$template.replace(new RegExp("\\sstyle=","img")," "+l+"=")),this["h_temp_"+n]=this["h_temp_"+n]||Handlebars.compile($(s).find(t).wrapAll("<div>").parent().html().replace(/ng-style/gim,"style"))):this["h_temp_"+n]=this["h_temp_"+n]||Handlebars.compile($(this.$template).find(t).wrapAll("<div>").parent().html()),_result=this["h_temp_"+n](e.attributes),this["h_temp_r_"+n]===_result)return;this.$(t).replaceWith(_result),this["h_temp_r_"+n]=_result}},this)),i&&Est.each(i,function(t){t.call(this,s)},this)}catch(n){console.log(n)}},_watch:function(t,e,i){var s,n=this,o=null,a={},l=[];"array"===Est.typeOf(t)?l=t:l.push(t),this.cbMap=this.cbMap||{},this.watchFields=this.watchFields||{},Est.each(l,function(t){var l=t.replace(/^#?model\d?-(.+)$/g,"$1");i&&(this.cbMap[l]=this.cbMap[l]||[],"string"===Est.typeOf(i)?(o=Est.hash(l+i),o in this.cbMap||(this.cbMap[o]=!0,this.cbMap[l].push(this[i]))):this.cbMap[l].push(i)),l in this.watchFields?Est.each(e.split(","),function(t){-1===this.watchFields[l].indexOf(t)&&(this.watchFields[l]=this.watchFields[l]+","+t)},this):this.watchFields[l]=e,e=this.watchFields[l],s=n.cid+l,s in a||(Est.off(a[s]=s).on(s,function(t,i){n._viewReplace(e,n.model,n.cbMap[l],l),n.update&&n.update.call(n,l)}),n.model.off("change:"+(a[l]=l.split(".")[0])).on("change:"+a[l],function(){n._viewReplace(e,n.model,n.cbMap[l],l),n.update&&n.update.call(n,l)}))},this)},_watchBind:function(t){var e=[],i=[];this.cbMap={},this.watchFields={},"string"===Est.typeOf(t)&&(i=t.match(new RegExp('(bb-watch=\\"(.+?)"(\\s*)|bb-change=\\"(.+?)"(\\s*)|bb-model=\\"(.+?)"(\\s*))(bb-action=\\"(.+?)\\"\\s*)?(bb-change=\\"(.+?)\\"\\s*)?',"img")),Est.each(i,this._bind(function(t){var i="",s="",n="",o="";i=/bb-watch=\"(.*?)\"\s?/gim.exec(t)||"",o=/bb-action=\"(.*?)\"\s?/gim.exec(t)||"",n=/bb-change=\"(.*?)\"\s?/gim.exec(t)||"",s=/bb-model=\"(.*?)\"\s?/gim.exec(t)||"",Est.isEmpty(i)&&Est.isEmpty(s)||e.push({watch:i.length>1?i[1]:s[1].split(":")[0],action:o.length>1?o[1]:"",change:n.length>1?n[1]:null})}))),Est.each(e,this._bind(function(t){this._watch(t.watch.split(","),t.action,Est.isEmpty(t.change)?null:t.change)})),this.onWatch&&this.onWatch.call(this,arguments)},_bbBind:function(t,e){var i,s,n,o={};if(this.bbList=[],"string"===Est.typeOf(t)){for(i=new RegExp('\\bbb-([\\w\\.]+)=\\"([\\w\\.:]+?)\\"\\s?',"img");null!==(n=i.exec(t));)this.bbList.push({name:n[1],value:n[2]});Est.each(this.bbList,this._bind(function(t){if(s=Est.hash(t.name+t.value),!(s in o))switch(o[s]=t,t.name){case"watch":break;case"action":break;case"change":break;case"show":console.log("name:"+t.name+";value:"+t.value);break;case"model":this._modelBind(e,'[bb-model="'+t.value+'"]'),this._watch([t.value.split(":")[0]],'[bb-model="'+t.value+'"]:value');break;case"checked":this._watch([t.value],'[bb-checked="'+t.value+'"]:checked'),this.$('[bb-checked="'+t.value+'"]').prop("checked",this._getValue(t.value));break;default:this[t.value]&&e.find("[bb-"+t.name+'="'+t.value+'"]').off(t.name).on(t.name,this._bind(this[t.value]))}}))}},_stringifyJSON:function(t){var e,i;JSON.stringify||alert(CONST.LANG.JSON_TIP),Est.each(t,function(t){e=t.split("."),e.length>1?(i=Est.getValue(this.model.attributes,t),Est.setValue(this.model.attributes,t,JSON.stringify(i))):Est.setValue(this.model.attributes,t,JSON.stringify(this.model.get(t)))},this)},_parseJSON:function(t){var e,i,s=JSON.parse||$.parseJSON;s||alert(CONST.LANG.JSON_TIP),Est.each(t,function(t){e=t.split("."),e.length>1?(i=Est.getValue(this.model.attributes,t),"string"===Est.typeOf(i)&&Est.setValue(this.model.attributes,t,s(i))):"string"===Est.typeOf(this.model.get(t))&&this.model.set(t,s(this.model.get(t)))},this)},_setOption:function(t){return Est.extend(this._options,t),this},_initEnterEvent:function(t){t.speed>1&&t.enterRender&&this.$("input").keyup($.proxy(function(e){e.keyCode===CONST.ENTER_KEY&&this.$(t.enterRender).click()},this))},_getOption:function(t){return this._options[t]},_getValue:function(t){return Est.getValue(this.model.attributes,t)},_get:function(t){return this._getValue.call(this,t)},_getDefault:function(t,e){return this._setDefault(t,e),Est.getValue(this.model.attributes,t)},_setDefault:function(t,e){var i=Est.getValue(this.model.attributes,t);("undefined"===Est.typeOf(i)||"null"===Est.typeOf(i))&&Est.setValue(this.model.attributes,t,e)},_initDefault:function(){this.init&&"function"===Est.typeOf(this.init)&&(this.__def_vals_=this.init.call(this)||{},Est.each(this.__def_vals_,this._bind(function(t,e){this._setDefault(e,t)})))},_reset:function(t){var e=[],i={};for(this.model.attributes={},t=Est.extend(Est.extend(this.model.defaults||{},this.__def_vals_),t),i=t;Est.keys(i).length>0;)t=i,Est.each(t,function(t,s){"object"===Est.typeOf(t)?Est.each(t,function(t,e){i[s+"."+e]=t}):e.push({path:s,value:t}),delete i[s]});Est.each(e,this._bind(function(t){this._set(t.path,t.value)}))},_setValue:function(t,e){Est.equal(Est.getValue(this.model.attributes,t),e)||(Est.setValue(this.model.attributes,t,e),Est.trigger(this.cid+t,t),this._m_change_=!0)},_set:function(t,e){this._m_change_=!1,"object"===Est.typeOf(t)?this._baseSetValues(t):this._setValue(t,e),this._m_change_&&this.options.onChange&&this.options.onChange.call(this,this.model.toJSON())},_baseSetValues:function(t){Est.each(t,this._bind(function(t,e){this._setValue(e,t)}))},_setValues:function(t){this._baseSetValues(t),this._options.onChange&&this._options.onChange.call(this,t)},_setAttr:function(t,e){"string"===Est.typeOf(t)?Est.setValue(this.model.attributes,t,e):Est.each(t,this._bind(function(t,e){Est.setValue(this.model.attributes,e,t)})),this._options.onChange&&this._options.onChange.call(this,t)},_getLength:function(){return this.collection.models.length},_getTarget:function(t){return t.target?$(t.target):$(t.currentTarget)},_getEventTarget:function(t){return t.currentTarget?$(t.currentTarget):$(t.target)},_one:function(t,e){try{var i,s="array"===Est.typeOf(t),n=[],o=null;i=s?t.join("_"):t,o="_one_"+i,this[o]="undefined"===Est.typeOf(this[o])?!0:!1,this[o]&&(s?(Est.each(t,function(t){n.push(t.replace(/^(.+)-(\d+)?$/g,"$1"))}),this._require(n,e)):e&&e.call(this))}catch(a){debug("SuperView._one "+JSON.stringify(t)+a,{type:"error"})}},_require:function(t,e){seajs.use(t,Est.proxy(e,this))},_delay:function(t,e){setTimeout(Est.proxy(function(){setTimeout(Est.proxy(function(){t&&t.call(this)},this),e)},this),0)},_bind:function(t){return Est.proxy(t,this)},_initToolTip:function(t,e){var i=e||".tool-tip",s=t?$(i,t):this.$(i);s.hover(function(t){var e=$(this).attr("data-title")||$(this).attr("title"),i=$(this).attr("data-offset")||0;Est.isEmpty(e)||(BaseUtils.dialog({id:Est.hash(e||"error:446"),title:null,width:"auto",offset:parseInt(i,10),skin:"tool-tip-dialog",align:$(this).attr("data-align")||"top",content:'<div style="padding: 5px 6px;;font-size: 12px;">'+e+"</div>",hideCloseBtn:!0,autofocus:!1,target:$(this).get(0)}),app.getData("toolTipList")||app.addData("toolTipList",[]),app.getData("toolTipList").push(Est.hash(e)),$(window).one("click",Est.proxy(function(){Est.each(app.getData("toolTipList"),function(t){app.getDialog(t)&&app.getDialog(t).close()}),app.addData("toolTipList",[])},this)))},function(){try{app.getDialog(Est.hash($(this).attr("data-title")||$(this).attr("title"))).close()}catch(t){}})},_empty:function(){},render:function(){this._render()}}),BaseView=SuperView.extend({_initialize:function(t){return this._initOptions(t),this._initTemplate(this._options.template),this._initModel(this._options.data,Backbone.Model.extend({fields:this._options.fields})),this._initBind(this._options),this.render(),this},_initOptions:function(t){this._options=Est.extend(this.options,t||{}),this._options.data=this._options.data||{}},_initTemplate:function(t){t&&(this.template=Handlebars.compile(t),this.$template="<div>"+t+"</div>")},_initModel:function(t,e){t&&(t.CONST=CONST),this.model=new e(t)},_initBind:function(t){this.model.bind("reset",this.render,this)},_render:function(){this._initDefault&&this._initDefault.call(this),this.beforeRender&&this.beforeRender.call(this,this._options),this._options.append?this.$el.append(this.template(this.model.attributes)):this.$el.html(this.template(this.model.attributes)),this._options.modelBind&&this._modelBind(),this.afterRender&&this.afterRender.call(this,this._options),this._watchBind&&this._watchBind.call(this,this._options.template),this._bbBind&&this._bbBind.call(this,this._options.template,this.$el),this._options.toolTip&&this._initToolTip(),this._initEnterEvent(this._options),BaseUtils.removeLoading()},render:function(){this._render()}}),BaseList=SuperView.extend({_initialize:function(t){return debug("1.BaseList._initialize"),this.dx=0,this.views=[],this._initOpt(t.collection,t)},_initOpt:function(t,e){return this._initOptions(e),this._initDataModel(Backbone.Model.extend({})),this._initTemplate(this._options),this._initEnterEvent(this._options,this),this._initList(this._options),this._initCollection(this._options,t),this._initItemView(this._options.item,this),this._initModel(this._options.model),this._initBind(this.collection),this._initPagination(this._options),this._load(this._options),this},_initOptions:function(t){this._options=Est.extend(this.options,t||{}),this._options.sortField="sort",this._options.max=this._options.max||99999,this._options.speed=this._options.speed||9},_initDataModel:function(t){this._options.data&&(this._options.data.CONST=CONST),this.model=new t(this._options.data)},_getTemp:function(){},_getIeTemp:function(){},_initTemplate:function(t){return this._data=t.data=t.data||{},t.template&&(this._initDefault&&this._initDefault.call(this),this.beforeRender&&this.beforeRender.call(this),this.$template=$("<div>"+t.template+"</div>"),this._options.render?(Est.msie()?(this.__template=t.template.replace(new RegExp("\\sstyle=","img")," ng-style="),this._options.itemTemp=$("<div>"+this.__template+"</div>").find(this._options.render).html(),Est.isEmpty(this._options.itemTemp)||(this._options.itemTemp=this._options.itemTemp.replace(/ng-style/gim,"style"))):this._options.itemTemp=this.$template.find(this._options.render).html(),this.$template.find(this._options.render).empty()):(Est.msie()?(this.__template=t.template.replace(new RegExp("\\sstyle=","img")," ng-style="),this._options.itemTemp=$("<div>"+this.__template+"</div>").html(),Est.isEmpty(this._options.itemTemp)||(this._options.itemTemp=this._options.itemTemp.replace(/ng-style/gim,"style"))):this._options.itemTemp=this.$template.html(),this.$template.empty()),this.template=Handlebars.compile(Est.isEmpty(this._options.itemTemp)?t.template:this.$template.html()),this._options.append?(this.$el.empty(),this.$el.append(this.template(this.model.attributes))):this.$el.html(this.template(this.model.attributes))),this._options.modelBind&&this._modelBind(),this._data},_initEnterEvent:function(t,e){t.enterRender&&e.$("input").keyup(function(i){i.keyCode===CONST.ENTER_KEY&&e.$(t.enterRender).click()})},_initList:function(t){var e=this;return this.list=t.render?this.$(t.render):this.$el,0===this.list.size()&&(this.list=$(t.render)),debug(function(){return e.list&&0!==e.list.size()?void 0:"Error1"},{type:"error"}),this.list},_initCollection:function(t,e){return debug(function(){return t.model?void 0:"Error2"},{type:"error"}),(!this.collection||this.collection&&!this.collection.remove)&&(this.collection=new e(t)),t.itemId&&this.collection._setItemId(t.itemId),t.subRender&&(this.composite=!0),this.collection},_initItemView:function(t){this.item=t},_initModel:function(t){this.initModel=t},_initBind:function(t){t&&(t.bind("add",this._addOne,this),t.bind("reset",this._render,this))},_initPagination:function(t){var e=this;e.collection&&e.collection.paginationModel&&e.collection.paginationModel.on("reloadList",function(i){e._setValue("checked_all",!1),e._clear.call(e),e._load.call(e,t,i)})},_load:function(t,e){var i=this;t=t||this._options||{},this._beforeLoad(t),(t.page||t.pageSize)&&(t.page&&i.collection.paginationModel.set("page",t.page||1),t._page=t.page,t.pageSize&&i.collection.paginationModel.set("pageSize",t.pageSize||16),t._pageSize=t.pageSize,e=i.collection.paginationModel,t.page=t.pageSize=null),this._watchBind&&this._watchBind.call(this,this._options.template),this._bbBind&&this._bbBind.call(this,this._options.template,this.$el),this._options.items&&(this._empty(),this._initItems()),this._options.viewId&&i.collection.paginationModel&&i.collection.paginationModel.get("pageSize")<999&&(app.addCookie(this._options.viewId+"_page"),Est.cookie(this._options.viewId+"_page",i.collection.paginationModel.get("page")),app.addCookie(this._options.viewId+"_pageSize"),Est.cookie(this._options.viewId+"_pageSize",i.collection.paginationModel.get("pageSize"))),i.collection.url&&!this._options.items?(i._options.filter&&(i.filter=!0),i._options.subRender&&(i.composite=!0,i.collection.paginationModel.set("page",1),i.collection.paginationModel.set("pageSize",9e3)),debug(function(){return"[Query]"+("function"===Est.typeOf(i.collection.url)?i.collection.url():i.collection.url)}),i.collection._load(i.collection,i,e).done(function(e){e&&e.msg&&e.msg===CONST.LANG.AUTH_FAILED&&BaseUtils.tip(CONST.LANG.AUTH_LIMIT+"！",{time:2e3}),i.list.find(".no-result").remove();try{(Est.isEmpty(e)||Est.isEmpty(e.attributes)||0===e.attributes.data.length)&&(i._options.append?i.list.append('<div class="no-result">'+CONST.LANG.LOAD_ALL+"</div>"):i.list.append('<div class="no-result">'+CONST.LANG.NO_RESULT+"</div>"),1===i.collection.paginationModel.get("page")&&Est.trigger("resultListNone"+i._options.viewId,{}),e.msg===CONST.LANG.NOT_LOGIN&&Est.trigger("checkLogin"),debug(function(){return"Warm3 list.length=0"+("function"===Est.typeOf(i.collection.url)?i.collection.url():i.collection.url)}))}catch(s){Est.trigger("checkLogin"),debug("Error4 "+e.msg)}i._afterLoad(t),i._options.subRender&&i._filterRoot(),i._options.filter&&i._filterCollection(),e.attributes&&e.attributes.model&&(i._options.data=Est.extend(i._options.data,e.attributes.model)),i._finally()})):(i._afterLoad(t),i._finally())},_reload:function(t){debug("BaseList_reload"),this._empty.call(this),this.collection.reset(),this.list.empty(),this._load(t)},_finally:function(){this.afterRender&&this.afterRender.call(this,this._options),this._options.toolTip&&this._initToolTip(),BaseUtils.removeLoading()},_beforeLoad:function(t){this.beforeLoad&&this.beforeLoad.call(this,this.collection)},_afterLoad:function(t){this.afterLoad&&this.afterLoad.call(this,this.collection);
},_initItems:function(){"function"===Est.typeOf(this._options.items)&&(this._options.items=this._options.items.apply(this,arguments)),this._options.filter&&(this.collection.push(this._options.items),this._filterCollection(),this._options.items=Est.pluck(Est.cloneDeep(this.collection.models,function(){},this),"attributes")),this._options._page||this._options._pageSize?this._renderListByPagination():this.filter||(Est.each(this._options.items,function(t){return this._check()?!1:void this.collection.push(new this.initModel(t))},this),this._options.subRender&&this._filterRoot())},_setTemplate:function(t){this.compileTemp=t},_getTemplate:function(){return this.compileTemp},_stop:function(){this.stopIterator=!0},_check:function(){return this.stopIterator?(this.stopIterator=!1,!0):!1},_render:function(){debug("BaseList._render"),this._addAll(),this.trigger("after",this)},_filterRoot:function(){var t=this,e=[],i=[];t.composite=!1,Est.each(t.collection.models,function(i){debug(function(){return"undefined"===Est.typeOf(i.attributes[t._options.categoryId])?"Error5 currentId = "+t._options.categoryId+";url="+t.collection.url:"undefined"===Est.typeOf(i.attributes[t._options.parentId])?"Error6 currentId="+t._options.parentId+";url="+t.collection.url:void 0},{type:"error"}),e.push({categoryId:i.attributes[t._options.categoryId],belongId:i.attributes[t._options.parentId]})}),this.collection.each(function(s){for(var n=e.length,o=[];n>0;){var a=e[n-1];a.belongId===s.get(t._options.categoryId)&&(o.unshift(a.categoryId),e.splice(n-1,1)),n--}s.set("children",o),s.set("id",s.get(t._options.categoryId)),"array"===Est.typeOf(t._options.rootValue)?Est.each(t._options.rootValue,Est.proxy(function(e){"function"===Est.typeOf(e)?e.call(this,e)&&(s.set("level",1),i.push(s)):!Est.isEmpty(e)&&s.get(t._options.rootId)&&s.get(t._options.rootId).indexOf(e)>-1?(s.set("level",1),i.push(s)):s.get(t._options.rootId)===e&&(s.set("level",1),i.push(s))},this)):s.get(t._options.rootId)===t._options.rootValue&&(s.set("level",1),i.push(s))}),Est.each(i,function(e){t._addOne(e)})},_addOne:function(t,e,i){var s=this;if(!this.filter&&!this.composite&&this.dx<this._options.max){switch(t.set({dx:this.dx++}),this._options.speed){case 1:t.set("_options",{});break;case 9:t.set("_options",{_speed:this._options.speed,_item:s._options.item,_items:s._options.items?!0:!1,_model:s._options.model,_collection:Est.isEmpty(s._options.subRender)?null:s.collection,_subRender:s._options.subRender,_collapse:s._options.collapse,_extend:s._options.extend,_checkAppend:s._options.checkAppend,_checkToggle:s._options.checkToggle,_data:s.options.data||s._options.data})}var n=new this.item({model:t,viewId:this._options.viewId,speed:this._options.speed,data:this._data,views:this.views,itemTemp:this._options.itemTemp});n._setInitModel(this.initModel),n._setViewId(this._options.viewId||app.getCurrentView()),i&&i.at<this.collection.models.length-1&&this.collection.models.length>1?this.collection.models[0===i.at?0:i.at-1].view.$el.after(n._render().el):this.list.append(n._render().el),this.views.push(n)}},_push:function(t,e){debug("BaseList._push");var i,s="number"===Est.typeOf(e)?e+1:0===this.collection.models.length?0:this.collection.models.length+1,n={at:s>this.collection.models.length?this.collection.models.length+2:s};t.cid||(t=new this.initModel(t)),this._options.items&&(i="array"===Est.typeOf(t)?Est.pluck(t,function(t){return t.attributes}):t.attributes,this._options.items.splice(n.at-1,0,i)),this.collection.push(t,n),Est.isEmpty(e)||this._exchangeOrder(s-1,s,{}),this._resetDx(),this._setValue("checked_all",!1)},_eq:function(t){return this.collection.models[t].view.$el},_resetDx:function(){debug("BaseList._resetDx");var t=0;Est.each(this.collection.models,function(e){e.set("dx",t),t++})},_findIndex:function(t){return Est.findIndex(this.collection.models,{cid:t.cid})},_filterCollection:function(){debug("BaseList._filterCollection"),this._filter(this._options.filter,this._options)},_renderListByPagination:function(){debug("BaseList._renderListByPagination"),this.page=this.collection.paginationModel.get("page"),this.pageSize=this.collection.paginationModel.get("pageSize"),this.startIndex=(this.page-1)*parseInt(this.pageSize,10),this.endIndex=this.startIndex+parseInt(this.pageSize,10);for(var t=this.startIndex;t<this.endIndex;t++)this.collection.push(this._options.items[t]);return this.collection.paginationModel.set("count",this._options.items.length),this.collection._paginationRender(),this.collection},_empty:function(){if(this.dx=0,debug("BaseList._empty"),this._options.append)return this.collection;if(this.collection&&!this.collection.remove,this.collection._reset&&this.collection._reset(),this.collection)for(var t=this.collection.length;t>-1;)this.collection.remove(this.collection[t]),t--;return this.collection.paginationModel&&(this.dx=(this.collection.paginationModel.get("pageSize")||16)*(this.collection.paginationModel.get("page")-1||0)),Est.each(this.views,function(t){t.remove().off()}),this.views=[],this.collection},_clear:function(){debug("BaseList._clear"),this._empty.call(this),this.list.empty(),this.collection.models.length=0},_addAll:function(){debug("BaseList._addAll and call this._empty"),this._empty(),this.collection.each(this._addOne,this)},_search:function(t){debug("BaseList._search");var e=this;this._clear(),this.filter=!0,t=Est.extend({onBeforeAdd:function(){}},t),this._load({page:1,pageSize:5e3,afterLoad:function(){e.filter=!1,e._options.items?e._filterItems(t.filter||e._options.filter,t):e._filter(t.filter||e._options.filter,t)}})},_filter:function(t,e){debug("BaseList._filter");var i=this,s=[],n=i.collection.models.length;for(i.filter=!1;n>0;){this._check()&&(n=-1);var o=i.collection.models[n-1],a=!0;if(Est.each(t,function(t){var e=!1,s=Est.getValue(o.attributes,t.key);return e="regexp"===Est.typeOf(t.match)?!t.match.test(s):Est.isEmpty(s)||-1===s.indexOf(t.value),a&&!Est.isEmpty(t.value)&&e?(i.collection.remove(o),a=!1,!1):void 0}),a&&e.onBeforeAdd){var l=e.onBeforeAdd.call(this,o);"boolean"!==Est.typeOf(l)||l||(a=!1)}a&&s.unshift(o),n--}Est.each(s,function(t){t.set("_isSearch",!0),i._addOne(t)})},_filterItems:function(t,e){debug("BaseList._filterItems");var i=this,s=[],n=Est.cloneDeep(i._options.items),o=n.length;for(i.filter=!1;o>0&&!this._check();){var a=n[o-1],l=!0;if(Est.each(t,function(t){var e=!1,i=Est.getValue(a,t.key);return e="regexp"===Est.typeOf(t.match)?!t.match.test(i):Est.isEmpty(i)||-1===i.indexOf(t.value),l&&!Est.isEmpty(t.value)&&e?(n.splice(o,1),l=!1,!1):void 0}),l&&e.onBeforeAdd){var r=e.onBeforeAdd.call(this,a);"boolean"!==Est.typeOf(r)||r||(l=!1)}l&&s.unshift(a),o--}Est.each(s,function(t){t=new i.initModel(t),t.set("_isSearch",!0),i.collection.push(t)})},_checkAll:function(t){var e,i=null;"boolean"===Est.typeOf(t)?this._setValue("checked_all",t):t?(i=this._getEventTarget(t),i.is("checkbox")?this._setValue("checked_all",i.get(0).checked):this._setValue("checked_all",!this._getValue("checked_all"))):this._setValue("checked_all",!this._getValue("checked_all")),e=this._getValue("checked_all"),this.collection.each(function(t){t.view._check(e),t.view.render()}),this._checkedAll(this._getValue("checked_all"))},_checkedAll:function(t){this._setValue("checked_all",t)},_saveSort:function(t){var e={id:t.get("id")};e[this._options.sortField||"sort"]=t.get(this._options.sortField),t._saveField(e,this,{async:!1,hideTip:!0})},_insertOrder:function(t,e,i){e>t&&e++,Est.arrayInsert(this.collection.models,t,e,{arrayExchange:Est.proxy(function(t,e,i,s){this._exchangeOrder(e,i,{path:this._options.sortField||"sort",success:function(t,e){t.get("id")&&e.get("id")?(t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},this),callback:function(t){i&&i.call(this,t)}}),this._resetDx()},_exchangeOrder:function(t,e,i){var s={},n={},o=this.collection.at(t),a=this.collection.at(e);if(o.view&&a.view){var l=o.view.model.get("dx"),r=a.view.model.get("dx");s.dx=r,n.dx=l}if(i.path){var h=o.view.model.get(i.path),c=a.view.model.get(i.path);s[i.path]=c,n[i.path]=h}return o.view.model.stopCollapse=!0,a.view.model.stopCollapse=!0,this.collection.models[e]=this.collection.models.splice(t,1,this.collection.models[e])[0],o.view.model.set(s),a.view.model.set(n),e>t?o.view.$el.before(a.view.$el).removeClass("hover"):o.view.$el.after(a.view.$el).removeClass("hover"),o.view.$el.hasClass("bui-grid-row-even")?(o.view.$el.removeClass("bui-grid-row-even"),a.view.$el.addClass("bui-grid-row-even")):(o.view.$el.addClass("bui-grid-row-even"),a.view.$el.removeClass("bui-grid-row-even")),i.success&&i.success.call(this,o,a),this},_moveUp:function(t){debug("BaseList._moveUp");var e,i,s=this,n=this.collection.indexOf(t),o=[];if(this._options.subRender){i=t.get(this._options.parentId),this.collection.each(function(t){i===t.get(s._options.parentId)&&o.push(t)});var a=Est.findIndex(o,function(e){return e.get("id")===t.get("id")});if(0===a)return;e=this.collection.indexOf(o[a-1])}else{if(0===n)return;e=n-1}this._exchangeOrder(n,e,{path:this._options.sortField||"sort",success:function(t,e){t.get("id")&&e.get("id")?(this._saveSort(t),this._saveSort(e),t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},_moveDown:function(t){debug("BaseList._moveDown");var e,i,s=this,n=this.collection.indexOf(t),o=[];if(this._options.subRender){i=t.get(s._options.parentId),this.collection.each(function(t){i===t.get(s._options.parentId)&&o.push(t)});var a=Est.findIndex(o,function(e){return e.get("id")===t.get("id")});if(a===o.length-1)return;e=this.collection.indexOf(o[a+1])}else{if(n===this.collection.models.length-1)return;e=n+1}this._exchangeOrder(n,e,{path:this._options.sortField,success:function(t,e){t.get("id")&&e.get("id")?(this._saveSort(t),this._saveSort(e),t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},_getCheckboxIds:function(t){return Est.pluck(this._getCheckedItems(),Est.isEmpty(t)?"id":"attributes."+t)},__filter:function(t){return t.attributes.checked},_getCheckedItems:function(t){return t?Est.chain(this.collection.models).filter(this.__filter).pluck("attributes").value():Est.chain(this.collection.models).filter(this.__filter).value()},_getItems:function(t){return Est.map(this.collection.models,function(e){return e.toJSON(t)})},_getItem:function(t){var e=this._getItems();return t=t||0,e.length>t?e[t]:null},_add:function(t){this.collection.push(t)},_batch:function(t){var e=this;return t=Est.extend({tip:CONST.LANG.SUCCESS+"！"},t),this.checkboxIds=this._getCheckboxIds(t.field||"id"),0===this.checkboxIds.length?void BaseUtils.tip(CONST.LANG.SELECT_ONE+"！"):void(t.url?$.ajax({type:"POST",async:!1,url:t.url,data:{ids:e.checkboxIds.join(",")},success:function(i){i.success?BaseUtils.tip(t.tip):BaseUtils.tip(i.msg),e._load(),t.callback&&t.callback.call(e,i)}}):(Est.each(this._getCheckedItems(),function(t){t.destroy()}),t.callback&&t.callback.call(e)))},_batchDel:function(t,e){var i=this,s=null,n="id",o=this._getEventTarget(t);return o.size()>0?(s=o.attr("data-url"),n=o.attr("data-field")||"id"):(s=t.url,id=t.id||"id"),this.checkboxIds=this._getCheckboxIds(n),this.checkboxIds&&0===this.checkboxIds.length?void BaseUtils.tip(CONST.LANG.SELECT_ONE):void BaseUtils.confirm({success:function(){i._batch({url:s,field:n,tip:CONST.LANG.DEL_SUCCESS,callback:e})}})},_clearChecked:function(){Est.each(this.collection.models,function(t){!Est.equal(t._previousAttributes.checked,t.attributes.checked)&&t.view&&(t.attributes.checked=!1,Est.trigger(t.view.cid+"checked","checked"))})}}),BaseItem=SuperView.extend({_initialize:function(t){this._initOptions(t),this._initCollapse(this.model.get("_options")),this._initTemplate(this._options),this._initBind(this._options),this._initView(this._options),this._initStyle(this._options),this._initEnterEvent(this._options)},_initOptions:function(t){this._options=Est.extend(this.options,t||{}),this._options.speed=this._options.speed||9},_initCollapse:function(t){t._speed>1&&(this.model.stopCollapse=!1,this.collapsed=t?t._extend:!1)},_initTemplate:function(t){t.template=t.template||t.itemTemp,t.template&&(this.$template="<div>"+t.template+"</div>",t.viewId?app.getCompileTemp(t.viewId)||app.addCompileTemp(t.viewId,Handlebars.compile(t.template)):this.template=Handlebars.compile(t.template))},_initBind:function(t){t.speed>1&&(this.model.bind("reset",this.render,this),this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this))},_initView:function(t){t.speed>1&&(this.model.view&&this.model.view.remove(),this.model.view=this)},_initStyle:function(t){if(t.speed>1){var e=this.model.get("id")?this.model.get("id")+"":this.model.get("dx")+1+"";this.model.get("dx")%2===0&&this.$el.addClass("bui-grid-row-even"),this.$el.addClass("_item_el_"+(this._options.viewId||"")+"_"+e.replace(/^[^1-9]+/,"")),this.$el.hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})}},_render:function(){debug("10.BaseItem._render"),this._onBeforeRender(),this._options&&this._options.filter&&this._options.filter.call(this,this.model),this.$el.html(this.template?this.template(this.model.attributes):this._options.viewId&&app.getCompileTemp(this._options.viewId)&&app.getCompileTemp(this._options.viewId)(this.model.attributes)),this._options.modelBind&&this._modelBind();var t=this.model.get("_options");if(t&&t._subRender&&this.model.get("children")&&this.model.get("children").length>0){var e=this,i=this.model.get("level")||1,s=this.$(t._subRender+":first");this._setupEvents(t),Est.each(this.model._getChildren(t._collection),function(n){var o=null;debug(function(){return Est.isEmpty(n)?"Error20":void 0},{type:"error"}),n.set("_options",t),n.set("level",i+1),o=new t._item({model:n,data:e._options._data}),o._setInitModel(e.initModel),o._setViewId(e._options.viewId),n.view=o,s.append(o.$el),e._options.views&&e._options.views.push(o),o._render()})}return this._onAfterRender(),this},_setViewId:function(t){this._options&&(this._options.viewId=t)},_setInitModel:function(t){this.initModel=t},_setupEvents:function(t){var e=this;e._toggleCollapse.call(this,t),this.$(t._collapse+":first").click(function(){e._toggleCollapse.call(e,t)})},_toggleCollapse:function(t){var e=this;return this.model.stopCollapse?void this.$(t._subRender+":first").addClass("hide"):(e.collapsed=!e.collapsed,void(e.collapsed?(this.$(t._collapse+":first").removeClass("x-caret-down"),this.$(t._subRender+":first").slideUp(CONST.COLLAPSE_SPEED).addClass("hide")):(this.$(t._collapse+":first").addClass("x-caret-down"),this.$(t._subRender+":first").slideDown(CONST.COLLAPSE_SPEED).removeClass("hide"))))},_onBeforeRender:function(){this._initDefault&&this._initDefault.call(this),this.beforeRender&&this.beforeRender.call(this,this.model)},_onAfterRender:function(){this._options.toolTip&&this._initToolTip(),this.afterRender&&this.afterRender.call(this,this.model),this._watchBind&&this._watchBind.call(this,this._options.template),this._bbBind&&this._bbBind.call(this,this._options.template,this.$el)},_close:function(){debug("BaseItem._close"),this.stopListening()},_clear:function(){debug("ProductItem._clear"),this.model.destroy()},_check:function(t){var e=this.model.get("checked"),i=null,s=null,n=null,o=!0;this._checkAppend="undefined"==typeof this.model.get("_options")._checkAppend?!1:this.model.get("_options")._checkAppend,this._checkToggle="undefined"==typeof this.model.get("_options")._checkToggle?!1:this.model.get("_options")._checkToggle,this._checkAppend||(this._options.viewId?app.getView(this._options.viewId)&&app.getView(this._options.viewId)._clearChecked():debug("Error21",{type:"error"})),this._checkToggle?this.model.attributes.checked="boolean"===Est.typeOf(t)?t:!e:(this.model.attributes.checked="boolean"===Est.typeOf(t)?t:!0,this._itemActive({add:this._checkAppend})),this.model.get("checked")&&this._checkToggle?this._itemActive({add:this._checkAppend}):this._checkToggle&&(this.$el.removeClass("item-active"),this.model.set("checked",!1)),t&&t.shiftKey&&this._checkAppend?(i=app.getData("curChecked"),s=this.model.get("dx"),Est.each(this.model.collection.models,function(t){n=t.get("dx"),n>i&&s>n&&(t.attributes.checked=!0,t.view.$el.addClass("item-active"))})):app.addData("curChecked",this.model.get("dx")),"boolean"!==Est.typeOf(t)&&t&&t.stopImmediatePropagation(),Est.trigger(this.cid+"checked","checked"),this.model.get("checked")?Est.each(this.model.collection.models,function(t){t.attributes.checked||(o=!1)}):o=!1,app.getView(this._options.viewId)&&app.getView(this._options.viewId)._checkedAll(o)},_itemActive:function(t){t=t||{},app.getData("itemActiveList"+this._options.viewId)||app.addData("itemActiveList"+this._options.viewId,[]);var e=app.getData("itemActiveList"+this._options.viewId);t.add||(debug("BaseItem._itemActive"),Est.each(e,Est.proxy(function(t){$("."+t,app.getView(this._options.viewId)?app.getView(this._options.viewId).$el:$("body")).removeClass("item-active")},this)),e.length=0),this.$el.addClass("item-active"),e.push(this.$el.attr("class").replace(/^.*(_item_el_.+?)\s+.*$/g,"$1"))},_moveUp:function(t){return t.stopImmediatePropagation(),this.collapsed=!0,this._options.viewId?void app.getView(this._options.viewId)._moveUp(this.model):(debug("Error22",{type:"error"}),!1)},_moveDown:function(t){return t.stopImmediatePropagation(),this.collapsed=!0,this._options.viewId?void app.getView(this._options.viewId)._moveDown(this.model):(debug("Error23",{type:"error"}),!1)},_saveSort:function(){var t=this,e=this.$(".input-sort").val();this.model._saveField({id:this.model.get("id"),sort:e},t,{success:function(){t.model.set("sort",e)},hideTip:!0})},_getPage:function(){var t=this.model.collection.paginationModel;return t?t.get("page"):1},_del:function(t,e){t&&t.stopImmediatePropagation(),debug("1.BaseItem._del");var i=this;return app.getData("delItemDialog")&&app.getData("delItemDialog").close(),i.model.get("children").length>0?void BaseUtils.confirm({title:CONST.LANG.TIP,width:300,content:CONST.LANG.DEL_TIP}):void app.addData("delItemDialog",BaseUtils.confirm({title:CONST.LANG.WARM_TIP,content:'<div class="item-delete-confirm">'+CONST.LANG.DEL_CONFIRM+"</div>",target:t&&this._getTarget(t).get(0),success:function(t){Est.isEmpty(i.model.url())&&(i.model.attributes.id=null),i.model.destroy({wait:!0,error:function(t,e){var i=[];i.push({value:CONST.LANG.CONFIRM,callback:function(){this.close()},autofocus:!0}),BaseUtils.dialog({title:CONST.LANG.TIP+"：",content:e.msg,width:250,button:i})},success:function(){i._removeFromItems(i.model.get("dx")),e&&e.call(i)}})}}))},_removeFromItems:function(t){"undefined"!==Est.typeOf(t)&&app.getView(this._options.viewId)&&(app.getView(this._options.viewId)._options.items&&app.getView(this._options.viewId)._options.items.splice(t,1),app.getView(this._options.viewId)._resetDx())}}),PaginationModel=Backbone.Model.extend({defaults:{page:1,pageSize:16,count:0},initialize:function(){debug("3.PaginationModel.initialize")}}),BaseCollection=Backbone.Collection.extend({constructor:function(t){this.options=t||{},Backbone.Collection.apply(this,[null,arguments])},_initialize:function(){debug("2.BaseCollection._initialize"),this._baseUrl=this.url,this.paginationModel||(this.paginationModel=new PaginationModel({page:this.options.page,pageSize:this.options.pageSize}))},initialize:function(){this._initialize()},parse:function(t,e){var i=this;return Est.isEmpty(t)?(debug(function(){var t="function"===Est.typeOf(i.url)?i.url():i.url;return"Error:14 "+t},{type:"error"}),[]):(this._parsePagination(t),this._parseUrl(this.paginationModel),this.options.pagination&&this.paginationModel&&this._paginationRender(),t.attributes.data)},_parseUrl:function(t){debug("- BaseCollection._parseUrl");var e=1,i=16;if(t&&t.get("pageSize")&&(i=t.get("pageSize"),e=t.get("page")),this.options.subRender&&(e=1,i=9e3),"function"!=typeof this.url){var s="";Est.isEmpty(this._itemId)||(s="/"+this._itemId),this.url=this._baseUrl+s+"?page="+e+"&pageSize="+i}},_parsePagination:function(t){debug("6.BaseCollection._parsePagination"),t.attributes=t.attributes||{page:1,per_page:10,count:10},this.paginationModel&&(this.paginationModel.set("page",t.attributes.page),this.paginationModel.set("pageSize",t.attributes.per_page),this.paginationModel.set("count",t.attributes.count))},_paginationRender:function(){seajs.use(["Pagination"],Est.proxy(function(t){if(this.pagination)this.pagination.render();else{var e=$(this.options.el),i="string"===Est.typeOf(this.options.pagination),s=$(i?this.options.pagination:"#pagination-container",e.size()>0?e:$("body"));i&&this.paginationModel.set("numLength",parseInt(s.attr("data-numLength")||7,10)),this.pagination=new t({el:s,model:this.paginationModel})}},this))},_load:function(t,e,i){return debug("4.BaseCollection._load"),this._parseUrl(i),t.fetch({success:function(){debug("5.collection reset"),e._empty()},cacheData:this.options.cache,session:this.options.session})},_setItemId:function(t){this._itemId=t,debug("- get list by itemId "+this._itemId)},_empty:function(){if(debug("BaseCollection._empty"),this.collection)for(var t=this.collection.length;t>-1;)this.collection.remove(this.collection[t]),t--}}),BaseModel=Backbone.Model.extend({defaults:{checked:!1,checked_all:!1,children:[]},baseId:"",url:function(){var t=this.baseUrl,e="";if(!t)return"";"function"===Est.typeOf(t)&&(t=t.call(this)),this.params=this.params?this.params:"";var i=Est.isEmpty(this.params)?"":"?";return this.isNew()&&Est.isEmpty(this.id)?t+i+this.params:(e=t+("/"==t.charAt(t.length-1)?"":"/")+this.id+i+this.params,debug(function(){return"[Query]"+e}),e)},_initialize:function(t){this.validateMsg=null,debug("9.BaseModel._initialize "+this.baseId)},parse:function(t,e){var i=this,s=[],n=!1;if("msg"in t&&BaseUtils.removeLoading(),Est.isEmpty(t)){var o="function"===Est.typeOf(this.url)?this.url():this.url;return debug("Error25 url"+o),BaseUtils.tip(CONST.LANG.REQUIRE_FAILED),!1}if(t&&t.msg&&t.msg===CONST.LANG.AUTH_FAILED&&BaseUtils.tip(CONST.LANG.AUTH_LIMIT,{time:2e3}),t.msg!==CONST.LANG.NOT_LOGIN||this.stopCheckLogin||Est.trigger("checkLogin"),t.msg&&!this.hideTip){t.success?(!i.isNew()||this.autoHide||this.hideAddBtn||(s.push({value:CONST.LANG.ADD_CONTINUE,callback:function(){i.set("id",null),i.set(i.baseId,null)}}),n=!0),!this.hideOkBtn&&s.push({value:CONST.LANG.CONFIRM,callback:function(){if(Est.trigger("_dialog_submit_callback"),this.autoBack="undefined"===Est.typeOf(this.autoBack)?!0:this.autoBack,"undefined"!=typeof window.topDialog)window.topDialog.close(),window.topDialog=null,$&&this.autoBack&&$(".btn-back").click();else if(app.getDialogs().length>0)try{app.getDialogs().pop().close().remove(),$&&this.autoBack&&$(".btn-back").click()}catch(t){}this.close()},autofocus:!0})):s.push({value:CONST.LANG.CONFIRM,callback:function(){this.close()},autofocus:!0}),this.hideOkBtn&&Est.trigger("_dialog_submit_callback");BaseUtils.dialog({id:"dialog_msg",title:CONST.LANG.TIP,content:'<div style="padding: 20px;">'+t.msg+"</div>",width:250,button:s});setTimeout(function(){app.getDialog("dialog_msg")&&(i.autoHide||!n)&&app.getDialog("dialog_msg").close().remove()},2e3)}if("boolean"===Est.typeOf(t.success)&&!t.success)return i.attributes._response=t,i.attributes;if(t.attributes&&t.attributes.data){var a=Est.keys(t.attributes);a.length>1&&Est.each(a,function(e){"data"!==e&&(t.attributes.data[e]=t.attributes[e])}),t=t.attributes.data}return t&&(t.id=t[i.baseId||"id"],t.checked=!1,t.time=(new Date).getTime()),t},_saveField:function(t,e,i){var s=i.async||!0,n=new e.initModel({id:t.id||e.model.get("id")});n.clear(),n.set(t),n.set("silent",!0),i.hideTip&&(n.hideTip=!0),n.hideOkBtn=!0,n.set("editField",!0),debug(function(){return n.baseUrl?void 0:"Error27"},{type:"console"}),n.baseUrl?n.save(null,{success:function(s,n){n.msg!==CONST.LANG.NOT_LOGIN||this.stopCheckLogin||Est.trigger("checkLogin"),"undefined"!=typeof i.success&&i.success&&i.success.call(e,t,n)},wait:s}):i.success&&i.success.call(e,t,{})},_getChildren:function(t){return Est.map(this.get("children"),function(e){return"string"==typeof e||"number"==typeof e?t.get(e):e})},_hideTip:function(){this.hideTip=!0},_toggle:function(){this.set("checked",!this.get("checked"))},_validation:function(t,e){return!t.silent&&e&&e.call(this,t),this.validateMsg},_getValue:function(t){return Est.getValue(this.attributes,t)},_setValue:function(t,e){Est.setValue(this.attributes,t,e)},initialize:function(){this._initialize()}}),BaseDetail=SuperView.extend({_initialize:function(t){this._initOptions(t),this._initTemplate(this._options),this._initList(this._options),this._initModel(t.model,this),this._initEnterEvent(this._options)},_initOptions:function(t){this._options=Est.extend(this.options,t||{}),this._options.speed=this._options.speed||9},_initTemplate:function(t){return this._data=t.data=t.data||{},t.template&&(this.template=Handlebars.compile(t.template),this.$template="<div>"+t.template+"</div>"),this._data},_initList:function(t){var e=this;return this.list=t.render?this.$(t.render):this.$el,0===this.list.size()&&(this.list=$(t.render)),debug(function(){return e.list&&0!==e.list.size()?void 0:"Error15 viewId="+e.options.viewId+(e._options.render?e._options.render:e.el)},{type:"error"}),this.list},_render:function(){this._initDefault&&this._initDefault.call(this),this.beforeRender&&this.beforeRender.call(this,this._options),this.list.append(this.template(this.model.attributes)),this._options.modelBind&&this._modelBind(),window.topDialog&&this.$(".form-actions").hide(),this._watchBind&&this._watchBind.call(this,this._options.template),this._bbBind&&this._bbBind.call(this,this._options.template,this.$el),this.afterRender&&this.afterRender.call(this,this._options),this._options.form&&this._form(this._options.form)._initSubmit({beforeSave:this.beforeSave,afterSave:this.afterSave}),this._options.toolTip&&this._initToolTip(),BaseUtils.removeLoading()},_initModel:function(t,e){debug(function(){return t?void 0:"Error16"},{type:"error"}),e.passId=this.options.id||this._options.data.id||Est.getUrlParam("id",window.location.href),Est.isEmpty(this.passId)?(e.passId=(new Date).getTime(),e.model=new t(this._options.data||{}),e.model.set("_data",e._options.data),e.model.set("_isAdd",e._isAdd=!0),e.render()):(e.model=new t,e.model.set("id",e.passId),e.model.set("_data",e._options.data),e.model.set("CONST",CONST),e.model.fetch().done(function(t){t.msg===CONST.LANG.NOT_LOGIN&&Est.trigger("checkLogin"),e.model.set("_isAdd",e._isAdd=!1),e.render()})),this._options.hideOkBtn&&(e.model.hideOkBtn=!0),this._options.hideSaveBtn&&(e.model.hideSaveBtn=!0),this._options.autoHide&&(e.model.autoHide=!0)},_form:function(t){return this.formSelector=t,this.formElemnet=this.$(this.formSelector),this},_validate:function(t){return this},_initSubmit:function(t){var e=this,i=!0,s=!0;t=t||{},$("#submit",this.el).on("click",function(){var n=$(this),o=n.is("input"),a=e.preText=o?n.val():n.html();if(i=!0,e.formElemnet.submit(),$("input, textarea, select",$(e.formSelector)).each(function(){var t,s,n,o,a;t=$(this).attr("name"),$(this).hasClass("bui-form-field-error")&&(i=!1);var l=$(this).attr("id");if(l&&-1!==l.indexOf("model")){switch(this.type){case"radio":s=$(this).is(":checked")?$(this).val():n=!0;break;case"checkbox":s=$(this).is(":checked")?Est.isEmpty($(this).attr("true-value"))?!0:$(this).attr("true-value"):Est.isEmpty($(this).attr("false-value"))?!1:$(this).attr("false-value");break;default:s=$(this).val()}if(!n)if(o=l.replace(/^model\d?-(.+)$/g,"$1"),a=o.split("."),a.length>1)try{e.model.attributes[a[0]]||(e.model.attributes[a[0]]={}),Est.setValue(e.model.attributes,o,s)}catch(r){debug("Error18 "+r)}else e.model.set(a[0],s)}}),i){if("undefined"!=typeof t.beforeSave&&(s=t.beforeSave.call(e)),"undefined"!==Est.typeOf(s)&&!s)return!1;o?n.val(CONST.LANG.SUBMIT):n.html(CONST.LANG.SUBMIT),n.prop("disabled",!0),e._save(function(i){t.afterSave&&(t.afterSave=Est.inject(t.afterSave,function(t){return new Est.setArguments(arguments)},function(t){o?n.val(a):n.html(a),n.prop("disabled",!1)}),t.afterSave.call(e,i,"string"===Est.typeOf(i)?!0:"boolean"===Est.typeOf(Est.getValue(i,"attributes._response.success"))?Est.getValue(i,"attributes._response.success"):!0)),n.html(a)},function(i){i.msg===CONST.LANG.NOT_LOGIN&&Est.trigger("checkLogin"),t.onErrorSave&&t.onErrorSave.call(e,i)}),setTimeout(function(){n.html(a),n.prop("disabled",!1)},5e3)}return!1})},_save:function(t,e){this._saveItem(t,e)},_saveItem:function(t,e){return debug("- BaseDetail._saveItem"),"string"===Est.typeOf(this.model.url)&&debug("Error29",{type:"error"}),Est.isEmpty(this.model.url())?void debug("Error19",{type:"error"}):(this.model.attributes._response&&delete this.model.attributes._response,void this.model.save(null,{wait:!0,success:function(e){debug("- BaseDetail._saveSuccess"),app.addModel(Est.cloneDeep(e.attributes)),top&&(top.model=e.attributes),t&&"function"==typeof t&&t.call(this,e)},error:function(i,s,n){200===s.status?t.call(this,s.responseText):e&&"function"==typeof e&&e.call(this,s,i,n)}}))},_empty:function(){this.model.off(),this.$el.empty().off()},_close:function(){debug("- BaseDetail.close"),this.undelegateEvents(),this.stopListening(),this.off()}});