var BaseList=SuperView.extend({_initialize:function(t){return debug("1.BaseList._initialize"),this.dx=0,this.views=[],this._initOpt(t.collection,t)},_initOpt:function(t,e){return this._initOptions(e),this._initDataModel(Backbone.Model.extend({})),this._initTemplate(this._options),this._initEnterEvent(this._options,this),this._initList(this._options),this._initCollection(this._options,t),this._initItemView(this._options.item,this),this._initModel(this._options.model),this._initBind(this.collection),this._initPagination(this._options),this._load(this._options),this},_initOptions:function(t){this._options=Est.extend(this.options,t||{}),this._options.sortField="sort",this._options.max=this._options.max||99999,this._options.speed=this._options.speed||9},_initDataModel:function(t){this._options.data&&(this._options.data.CONST=CONST),this.model=new t(this._options.data)},_getTemp:function(){},_getIeTemp:function(){},_initTemplate:function(t){return this._data=t.data=t.data||{},t.template&&(this._initDefault&&this._initDefault.call(this),this.beforeRender&&this.beforeRender.call(this),this.$template=$("<div>"+t.template+"</div>"),this._options.render?(Est.msie()?(this.__template=t.template.replace(new RegExp("\\sstyle=","img")," ng-style="),this._options.itemTemp=$("<div>"+this.__template+"</div>").find(this._options.render).html(),Est.isEmpty(this._options.itemTemp)||(this._options.itemTemp=this._options.itemTemp.replace(/ng-style/gim,"style"))):this._options.itemTemp=this.$template.find(this._options.render).html(),this.$template.find(this._options.render).empty()):(Est.msie()?(this.__template=t.template.replace(new RegExp("\\sstyle=","img")," ng-style="),this._options.itemTemp=$("<div>"+this.__template+"</div>").html(),Est.isEmpty(this._options.itemTemp)||(this._options.itemTemp=this._options.itemTemp.replace(/ng-style/gim,"style"))):this._options.itemTemp=this.$template.html(),this.$template.empty()),this.template=Handlebars.compile(Est.isEmpty(this._options.itemTemp)?t.template:this.$template.html()),this._options.append?(this.$el.empty(),this.$el.append(this.template(this.model.attributes))):this.$el.html(this.template(this.model.attributes))),this._options.modelBind&&this._modelBind(),this._data},_initEnterEvent:function(t,e){t.enterRender&&e.$("input").keyup(function(i){i.keyCode===CONST.ENTER_KEY&&e.$(t.enterRender).click()})},_initList:function(t){var e=this;return this.list=t.render?this.$(t.render):this.$el,0===this.list.size()&&(this.list=$(t.render)),debug(function(){return e.list&&0!==e.list.size()?void 0:"Error1"},{type:"error"}),this.list},_initCollection:function(t,e){return debug(function(){return t.model?void 0:"Error2"},{type:"error"}),(!this.collection||this.collection&&!this.collection.remove)&&(this.collection=new e(t)),t.itemId&&this.collection._setItemId(t.itemId),t.subRender&&(this.composite=!0),this.collection},_initItemView:function(t){this.item=t},_initModel:function(t){this.initModel=t},_initBind:function(t){t&&(t.bind("add",this._addOne,this),t.bind("reset",this._render,this))},_initPagination:function(t){var e=this;e.collection&&e.collection.paginationModel&&e.collection.paginationModel.on("reloadList",function(i){e._setValue("checked_all",!1),e._clear.call(e),e._load.call(e,t,i)})},_load:function(t,e){var i=this;t=t||this._options||{},this._beforeLoad(t),(t.page||t.pageSize)&&(t.page&&i.collection.paginationModel.set("page",t.page||1),t._page=t.page,t.pageSize&&i.collection.paginationModel.set("pageSize",t.pageSize||16),t._pageSize=t.pageSize,e=i.collection.paginationModel,t.page=t.pageSize=null),this._watchBind&&this._watchBind.call(this,this._options.template),this._bbBind&&this._bbBind.call(this,this._options.template,this.$el),this._options.items&&(this._empty(),this._initItems()),this._options.viewId&&i.collection.paginationModel&&i.collection.paginationModel.get("pageSize")<999&&(app.addCookie(this._options.viewId+"_page"),Est.cookie(this._options.viewId+"_page",i.collection.paginationModel.get("page")),app.addCookie(this._options.viewId+"_pageSize"),Est.cookie(this._options.viewId+"_pageSize",i.collection.paginationModel.get("pageSize"))),i.collection.url&&!this._options.items?(i._options.filter&&(i.filter=!0),i._options.subRender&&(i.composite=!0,i.collection.paginationModel.set("page",1),i.collection.paginationModel.set("pageSize",9e3)),debug(function(){return"[Query]"+("function"===Est.typeOf(i.collection.url)?i.collection.url():i.collection.url)}),i.collection._load(i.collection,i,e).done(function(e){e&&e.msg&&e.msg===CONST.LANG.AUTH_FAILED&&BaseUtils.tip(CONST.LANG.AUTH_LIMIT+"！",{time:2e3}),i.list.find(".no-result").remove();try{(Est.isEmpty(e)||Est.isEmpty(e.attributes)||0===e.attributes.data.length)&&(i._options.append?i.list.append('<div class="no-result">'+CONST.LANG.LOAD_ALL+"</div>"):i.list.append('<div class="no-result">'+CONST.LANG.NO_RESULT+"</div>"),1===i.collection.paginationModel.get("page")&&Est.trigger("resultListNone"+i._options.viewId,{}),e.msg===CONST.LANG.NOT_LOGIN&&Est.trigger("checkLogin"),debug(function(){return"Warm3 list.length=0"+("function"===Est.typeOf(i.collection.url)?i.collection.url():i.collection.url)}))}catch(s){Est.trigger("checkLogin"),debug("Error4 "+e.msg)}i._afterLoad(t),i._options.subRender&&i._filterRoot(),i._options.filter&&i._filterCollection(),e.attributes&&e.attributes.model&&(i._options.data=Est.extend(i._options.data,e.attributes.model)),i._finally()})):(i._afterLoad(t),i._finally())},_reload:function(t){debug("BaseList_reload"),this._empty.call(this),this.collection.reset(),this.list.empty(),this._load(t)},_finally:function(){this.afterRender&&this.afterRender.call(this,this._options),this._options.toolTip&&this._initToolTip(),BaseUtils.removeLoading()},_beforeLoad:function(t){this.beforeLoad&&this.beforeLoad.call(this,this.collection)},_afterLoad:function(t){this.afterLoad&&this.afterLoad.call(this,this.collection)},_initItems:function(){"function"===Est.typeOf(this._options.items)&&(this._options.items=this._options.items.apply(this,arguments)),this._options.filter&&(this.collection.push(this._options.items),this._filterCollection(),this._options.items=Est.pluck(Est.cloneDeep(this.collection.models,function(){},this),"attributes")),this._options._page||this._options._pageSize?this._renderListByPagination():this.filter||(Est.each(this._options.items,function(t){return this._check()?!1:void this.collection.push(new this.initModel(t))},this),this._options.subRender&&this._filterRoot())},_setTemplate:function(t){this.compileTemp=t},_getTemplate:function(){return this.compileTemp},_stop:function(){this.stopIterator=!0},_check:function(){return this.stopIterator?(this.stopIterator=!1,!0):!1},_render:function(){debug("BaseList._render"),this._addAll(),this.trigger("after",this)},_filterRoot:function(){var t=this,e=[],i=[];t.composite=!1,Est.each(t.collection.models,function(i){debug(function(){return"undefined"===Est.typeOf(i.attributes[t._options.categoryId])?"Error5 currentId = "+t._options.categoryId+";url="+t.collection.url:"undefined"===Est.typeOf(i.attributes[t._options.parentId])?"Error6 currentId="+t._options.parentId+";url="+t.collection.url:void 0},{type:"error"}),e.push({categoryId:i.attributes[t._options.categoryId],belongId:i.attributes[t._options.parentId]})}),this.collection.each(function(s){for(var o=e.length,n=[];o>0;){var l=e[o-1];l.belongId===s.get(t._options.categoryId)&&(n.unshift(l.categoryId),e.splice(o-1,1)),o--}s.set("children",n),s.set("id",s.get(t._options.categoryId)),"array"===Est.typeOf(t._options.rootValue)?Est.each(t._options.rootValue,Est.proxy(function(e){"function"===Est.typeOf(e)?e.call(this,e)&&(s.set("level",1),i.push(s)):!Est.isEmpty(e)&&s.get(t._options.rootId)&&s.get(t._options.rootId).indexOf(e)>-1?(s.set("level",1),i.push(s)):s.get(t._options.rootId)===e&&(s.set("level",1),i.push(s))},this)):s.get(t._options.rootId)===t._options.rootValue&&(s.set("level",1),i.push(s))}),Est.each(i,function(e){t._addOne(e)})},_addOne:function(t,e,i){var s=this;if(!this.filter&&!this.composite&&this.dx<this._options.max){switch(t.set({dx:this.dx++}),this._options.speed){case 1:t.set("_options",{});break;case 9:t.set("_options",{_speed:this._options.speed,_item:s._options.item,_items:s._options.items?!0:!1,_model:s._options.model,_collection:Est.isEmpty(s._options.subRender)?null:s.collection,_subRender:s._options.subRender,_collapse:s._options.collapse,_extend:s._options.extend,_checkAppend:s._options.checkAppend,_checkToggle:s._options.checkToggle,_data:s.options.data||s._options.data})}var o=new this.item({model:t,viewId:this._options.viewId,speed:this._options.speed,data:this._data,views:this.views,itemTemp:this._options.itemTemp});o._setInitModel(this.initModel),o._setViewId(this._options.viewId||app.getCurrentView()),i&&i.at<this.collection.models.length-1&&this.collection.models.length>1?this.collection.models[0===i.at?0:i.at-1].view.$el.after(o._render().el):this.list.append(o._render().el),this.views.push(o)}},_push:function(t,e){debug("BaseList._push");var i,s="number"===Est.typeOf(e)?e+1:0===this.collection.models.length?0:this.collection.models.length+1,o={at:s>this.collection.models.length?this.collection.models.length+2:s};t.cid||(t=new this.initModel(t)),this._options.items&&(i="array"===Est.typeOf(t)?Est.pluck(t,function(t){return t.attributes}):t.attributes,this._options.items.splice(o.at-1,0,i)),this.collection.push(t,o),Est.isEmpty(e)||this._exchangeOrder(s-1,s,{}),this._resetDx(),this._setValue("checked_all",!1)},_eq:function(t){return this.collection.models[t].view.$el},_resetDx:function(){debug("BaseList._resetDx");var t=0;Est.each(this.collection.models,function(e){e.set("dx",t),t++})},_findIndex:function(t){return Est.findIndex(this.collection.models,{cid:t.cid})},_filterCollection:function(){debug("BaseList._filterCollection"),this._filter(this._options.filter,this._options)},_renderListByPagination:function(){debug("BaseList._renderListByPagination"),this.page=this.collection.paginationModel.get("page"),this.pageSize=this.collection.paginationModel.get("pageSize"),this.startIndex=(this.page-1)*parseInt(this.pageSize,10),this.endIndex=this.startIndex+parseInt(this.pageSize,10);for(var t=this.startIndex;t<this.endIndex;t++)this.collection.push(this._options.items[t]);return this.collection.paginationModel.set("count",this._options.items.length),this.collection._paginationRender(),this.collection},_empty:function(){if(this.dx=0,debug("BaseList._empty"),this._options.append)return this.collection;if(this.collection&&!this.collection.remove,this.collection._reset&&this.collection._reset(),this.collection)for(var t=this.collection.length;t>-1;)this.collection.remove(this.collection[t]),t--;return this.collection.paginationModel&&(this.dx=(this.collection.paginationModel.get("pageSize")||16)*(this.collection.paginationModel.get("page")-1||0)),Est.each(this.views,function(t){t.remove().off()}),this.views=[],this.collection},_clear:function(){debug("BaseList._clear"),this._empty.call(this),this.list.empty(),this.collection.models.length=0},_addAll:function(){debug("BaseList._addAll and call this._empty"),this._empty(),this.collection.each(this._addOne,this)},_search:function(t){debug("BaseList._search");var e=this;this._clear(),this.filter=!0,t=Est.extend({onBeforeAdd:function(){}},t),this._load({page:1,pageSize:5e3,afterLoad:function(){e.filter=!1,e._options.items?e._filterItems(t.filter||e._options.filter,t):e._filter(t.filter||e._options.filter,t)}})},_filter:function(t,e){debug("BaseList._filter");var i=this,s=[],o=i.collection.models.length;for(i.filter=!1;o>0;){this._check()&&(o=-1);var n=i.collection.models[o-1],l=!0;if(Est.each(t,function(t){var e=!1,s=Est.getValue(n.attributes,t.key);return e="regexp"===Est.typeOf(t.match)?!t.match.test(s):Est.isEmpty(s)||-1===s.indexOf(t.value),l&&!Est.isEmpty(t.value)&&e?(i.collection.remove(n),l=!1,!1):void 0}),l&&e.onBeforeAdd){var c=e.onBeforeAdd.call(this,n);"boolean"!==Est.typeOf(c)||c||(l=!1)}l&&s.unshift(n),o--}Est.each(s,function(t){t.set("_isSearch",!0),i._addOne(t)})},_filterItems:function(t,e){debug("BaseList._filterItems");var i=this,s=[],o=Est.cloneDeep(i._options.items),n=o.length;for(i.filter=!1;n>0&&!this._check();){var l=o[n-1],c=!0;if(Est.each(t,function(t){var e=!1,i=Est.getValue(l,t.key);return e="regexp"===Est.typeOf(t.match)?!t.match.test(i):Est.isEmpty(i)||-1===i.indexOf(t.value),c&&!Est.isEmpty(t.value)&&e?(o.splice(n,1),c=!1,!1):void 0}),c&&e.onBeforeAdd){var a=e.onBeforeAdd.call(this,l);"boolean"!==Est.typeOf(a)||a||(c=!1)}c&&s.unshift(l),n--}Est.each(s,function(t){t=new i.initModel(t),t.set("_isSearch",!0),i.collection.push(t)})},_checkAll:function(t){var e,i=null;"boolean"===Est.typeOf(t)?this._setValue("checked_all",t):t?(i=this._getEventTarget(t),i.is("checkbox")?this._setValue("checked_all",i.get(0).checked):this._setValue("checked_all",!this._getValue("checked_all"))):this._setValue("checked_all",!this._getValue("checked_all")),e=this._getValue("checked_all"),this.collection.each(function(t){t.view._check(e),t.view.render()}),this._checkedAll(this._getValue("checked_all"))},_checkedAll:function(t){this._setValue("checked_all",t)},_saveSort:function(t){var e={id:t.get("id")};e[this._options.sortField||"sort"]=t.get(this._options.sortField),t._saveField(e,this,{async:!1,hideTip:!0})},_insertOrder:function(t,e,i){e>t&&e++,Est.arrayInsert(this.collection.models,t,e,{arrayExchange:Est.proxy(function(t,e,i,s){this._exchangeOrder(e,i,{path:this._options.sortField||"sort",success:function(t,e){t.get("id")&&e.get("id")?(t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},this),callback:function(t){i&&i.call(this,t)}}),this._resetDx()},_exchangeOrder:function(t,e,i){var s={},o={},n=this.collection.at(t),l=this.collection.at(e);if(n.view&&l.view){var c=n.view.model.get("dx"),a=l.view.model.get("dx");s.dx=a,o.dx=c}if(i.path){var h=n.view.model.get(i.path),r=l.view.model.get(i.path);s[i.path]=r,o[i.path]=h}return n.view.model.stopCollapse=!0,l.view.model.stopCollapse=!0,this.collection.models[e]=this.collection.models.splice(t,1,this.collection.models[e])[0],n.view.model.set(s),l.view.model.set(o),e>t?n.view.$el.before(l.view.$el).removeClass("hover"):n.view.$el.after(l.view.$el).removeClass("hover"),n.view.$el.hasClass("bui-grid-row-even")?(n.view.$el.removeClass("bui-grid-row-even"),l.view.$el.addClass("bui-grid-row-even")):(n.view.$el.addClass("bui-grid-row-even"),l.view.$el.removeClass("bui-grid-row-even")),i.success&&i.success.call(this,n,l),this},_moveUp:function(t){debug("BaseList._moveUp");var e,i,s=this,o=this.collection.indexOf(t),n=[];if(this._options.subRender){i=t.get(this._options.parentId),this.collection.each(function(t){i===t.get(s._options.parentId)&&n.push(t)});var l=Est.findIndex(n,function(e){return e.get("id")===t.get("id")});if(0===l)return;e=this.collection.indexOf(n[l-1])}else{if(0===o)return;e=o-1}this._exchangeOrder(o,e,{path:this._options.sortField||"sort",success:function(t,e){t.get("id")&&e.get("id")?(this._saveSort(t),this._saveSort(e),t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},_moveDown:function(t){debug("BaseList._moveDown");var e,i,s=this,o=this.collection.indexOf(t),n=[];if(this._options.subRender){i=t.get(s._options.parentId),this.collection.each(function(t){i===t.get(s._options.parentId)&&n.push(t)});var l=Est.findIndex(n,function(e){return e.get("id")===t.get("id")});if(l===n.length-1)return;e=this.collection.indexOf(n[l+1])}else{if(o===this.collection.models.length-1)return;e=o+1}this._exchangeOrder(o,e,{path:this._options.sortField,success:function(t,e){t.get("id")&&e.get("id")?(this._saveSort(t),this._saveSort(e),t.stopCollapse=!1,e.stopCollapse=!1):debug("Error8")}})},_getCheckboxIds:function(t){return Est.pluck(this._getCheckedItems(),Est.isEmpty(t)?"id":"attributes."+t)},__filter:function(t){return t.attributes.checked},_getCheckedItems:function(t){return t?Est.chain(this.collection.models).filter(this.__filter).pluck("attributes").value():Est.chain(this.collection.models).filter(this.__filter).value()},_getItems:function(t){return Est.map(this.collection.models,function(e){return e.toJSON(t)})},_getItem:function(t){var e=this._getItems();return t=t||0,e.length>t?e[t]:null},_add:function(t){this.collection.push(t)},_batch:function(t){var e=this;return t=Est.extend({tip:CONST.LANG.SUCCESS+"！"},t),this.checkboxIds=this._getCheckboxIds(t.field||"id"),0===this.checkboxIds.length?void BaseUtils.tip(CONST.LANG.SELECT_ONE+"！"):void(t.url?$.ajax({type:"POST",async:!1,url:t.url,data:{ids:e.checkboxIds.join(",")},success:function(i){i.success?BaseUtils.tip(t.tip):BaseUtils.tip(i.msg),e._load(),t.callback&&t.callback.call(e,i)}}):(Est.each(this._getCheckedItems(),function(t){t.destroy()}),t.callback&&t.callback.call(e)))},_batchDel:function(t,e){var i=this,s=null,o="id",n=this._getEventTarget(t);return n.size()>0?(s=n.attr("data-url"),o=n.attr("data-field")||"id"):(s=t.url,id=t.id||"id"),this.checkboxIds=this._getCheckboxIds(o),this.checkboxIds&&0===this.checkboxIds.length?void BaseUtils.tip(CONST.LANG.SELECT_ONE):void BaseUtils.confirm({success:function(){i._batch({url:s,field:o,tip:CONST.LANG.DEL_SUCCESS,callback:e})}})},_clearChecked:function(){Est.each(this.collection.models,function(t){!Est.equal(t._previousAttributes.checked,t.attributes.checked)&&t.view&&(t.attributes.checked=!1,Est.trigger(t.view.cid+"checked","checked"))})}});